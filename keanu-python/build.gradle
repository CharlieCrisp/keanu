assemble.dependsOn(":shadowJar")
assemble.dependsOn(":codegen:processor:codeGen")

task installPipenv {
    doLast {
        exec {
            // temporarily fixing the version as 2018.10.9 seems to be broken:
            // TypeError: stat: path should be string, bytes, os.PathLike or integer, not NoneType
            commandLine 'pip', 'install', 'pipenv==2018.7.1'
        }
        exec {
            // temporary workaround for https://github.com/pypa/pipenv/issues/2924
            // (pip 18.1 broke pipenv)
            commandLine 'pipenv', 'run', 'pip', 'install', 'pip==18.0'
        }
        exec {
            commandLine 'pipenv', 'install', '--dev', '--three'
        }
    }
}

task pythonVersionInfo {
    doLast {
        exec {
            commandLine 'python', '--version'
        }
        exec {
            commandLine 'pip', '--version'
        }
        exec {
            commandLine 'pipenv', '--version'
        }
        exec {
            // NB: the python version inside pipenv is not necessarily the same as the version outside pipenv
            commandLine 'pipenv', 'run', 'python', '--version'
        }
        exec {
            // NB: the pip version inside pipenv is not necessarily the same as the version outside pipenv
            commandLine 'pipenv', 'run', 'pip', '--version'
        }
    }
}
task pytest {
    doLast {
        exec {
            commandLine 'pipenv', 'run', 'pytest'
        }
    }
}

test.dependsOn(pytest)
pytest.dependsOn(installPipenv)
pytest.dependsOn(pythonVersionInfo)
pythonVersionInfo.mustRunAfter(installPipenv)
